# Gordion Relay System - Architecture Diagrams

## 1. Overall System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          EXTERNAL USERS                                 â”‚
â”‚                                                                         â”‚
â”‚   Doctors, Radiologists, Medical Staff accessing DICOM files          â”‚
â”‚                                                                         â”‚
â”‚   Browser: https://ankara.zenpacs.com.tr/api/instances/123/download   â”‚
â”‚   Browser: https://istanbul.zenpacs.com.tr/api/studies/456            â”‚
â”‚   Browser: https://samsun.zenpacs.com.tr/weasis.xml                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                   â”‚                  â”‚
                 â”‚ DNS Lookup        â”‚ DNS Lookup       â”‚ DNS Lookup
                 â”‚ *.zenpacs.com.tr  â”‚                  â”‚
                 â–¼                   â–¼                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚       Wildcard DNS: *.zenpacs.com.tr                  â”‚
         â”‚       Points to: 45.123.45.67 (Public VPS)            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ All subdomains resolve to
                                 â”‚ same relay server IP
                                 â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    RELAY SERVER (Public VPS)                           â•‘
â•‘                  IP: 45.123.45.67 (Public)                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              Port 80 (TCP)                                  â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
    â”‚   â”‚  HTTP Redirect Server                         â”‚         â”‚
    â”‚   â”‚  â€¢ ACME HTTP-01 Challenges (Let's Encrypt)   â”‚         â”‚
    â”‚   â”‚  â€¢ Redirect all HTTP â†’ HTTPS                 â”‚         â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              Port 443 (TCP/HTTPS + WebSocket)               â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
    â”‚   â”‚  HTTPS Server + WebSocket Upgrade            â”‚         â”‚
    â”‚   â”‚                                               â”‚         â”‚
    â”‚   â”‚  1. Accept HTTPS connection                  â”‚         â”‚
    â”‚   â”‚  2. Upgrade /tunnel to WebSocket             â”‚         â”‚
    â”‚   â”‚  3. Handle protocol:                         â”‚         â”‚
    â”‚   â”‚     â€¢ "REGISTER ..." â†’ WebSocket tunnel      â”‚         â”‚
    â”‚   â”‚     â€¢ Other HTTP â†’ forward via tunnel        â”‚         â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
    â”‚          â”‚                     â”‚                            â”‚
    â”‚    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
    â”‚    â”‚ Tunnel     â”‚       â”‚ HTTP Request   â”‚               â”‚
    â”‚    â”‚ Handler    â”‚       â”‚ Handler        â”‚               â”‚
    â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
    â”‚          â”‚                     â”‚                            â”‚
    â”‚          â”‚                     â”‚                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                     â”‚
               â”‚                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              Port 8080 (TCP)                                â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
    â”‚   â”‚  Metrics & Status Server                      â”‚         â”‚
    â”‚   â”‚  â€¢ GET /health â†’ OK                           â”‚         â”‚
    â”‚   â”‚  â€¢ GET /status â†’ Connected hospitals JSON    â”‚         â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

               â”‚                     â”‚
               â”‚ Tunnel              â”‚ Forward request
               â”‚ Registration        â”‚ through tunnel
               â”‚                     â”‚
               â–¼                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
    â”‚  Hospital Registry   â”‚        â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        â”‚
    â”‚  â”‚ ankara â†’ Conn1 â”‚  â”‚        â”‚
    â”‚  â”‚ istanbulâ†’Conn2 â”‚  â”‚        â”‚
    â”‚  â”‚ samsun â†’ Conn3 â”‚  â”‚        â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
               â”‚                     â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                            â”‚                     â”‚
         â–¼                            â–¼                     â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  HOSPITAL ANKARA   â•‘    â•‘ HOSPITAL ISTANBUL  â•‘   â•‘  HOSPITAL SAMSUN   â•‘
â•‘  (Private Network) â•‘    â•‘  (Private Network) â•‘   â•‘  (Private Network) â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ğŸ¥ HOSPITAL NETWORK                              â”‚
â”‚                  (Behind Firewall / NAT)                             â”‚
â”‚                  Private IP: 10.1.1.0/24                             â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    ğŸ”¥ FIREWALL                              â”‚   â”‚
â”‚  â”‚  âœ… Outbound HTTPS (443) â†’ Allowed                          â”‚   â”‚
â”‚  â”‚  âŒ Inbound connections â†’ Blocked                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            GORDIONEDGE SERVER (10.1.1.50)                   â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  Tunnel Agent                                       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Connects TO relay (outbound)                    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Keeps connection alive (heartbeat)              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Receives requests FROM relay                    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Forwards to localhost:8083                      â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                  â”‚                                          â”‚   â”‚
â”‚  â”‚                  â–¼                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  Gordionedge HTTP Server (localhost:8083)          â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ DICOM C-STORE receiver (port 11113)            â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ HTTP API for DICOM files                        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Local cache (100GB)                             â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ MinIO uploader                                  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ BadgerDB pipeline                               â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  PACS / Modality Devices                                    â”‚   â”‚
â”‚  â”‚  â€¢ CT Scanner â†’ DICOM C-STORE â†’ Gordionedge:11113          â”‚   â”‚
â”‚  â”‚  â€¢ MRI Machine â†’ DICOM C-STORE â†’ Gordionedge:11113         â”‚   â”‚
â”‚  â”‚  â€¢ X-Ray â†’ DICOM C-STORE â†’ Gordionedge:11113               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. Tunnel Registration Flow (Hospital Startup)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   TUNNEL REGISTRATION SEQUENCE                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Hospital                          Relay Server
Gordionedge                       (45.123.45.67:443)
   â”‚                                    â”‚
   â”‚ 1. Gordionedge starts              â”‚
   â”‚    Config loaded:                  â”‚
   â”‚    - hospital_code: "ankara"       â”‚
   â”‚    - token: "SECRET123"            â”‚
   â”‚    - relay: relay.zenpacs.com.tr   â”‚
   â”‚                                    â”‚
   â”‚ 2. DNS Lookup                      â”‚
   â”‚    relay.zenpacs.com.tr            â”‚
   â”‚    â†’ 45.123.45.67                  â”‚
   â”‚                                    â”‚
   â”‚ 3. Open WebSocket Connection        â”‚
   â”‚    (Outbound HTTPS - Firewall allows)â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€ wss://relay/tunnel â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚    TLS Handshake                   â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€ TLS Certificate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                    â”‚
   â”‚ 4. Connection Established          â”‚
   â”‚    Local:  10.1.1.50:52341        â”‚
   â”‚    Remote: 45.123.45.67:443       â”‚
   â”‚                                    â”‚
   â”‚ 5. Send Registration               â”‚
   â”‚                                    â”‚
   â”‚ 6. Send Registration               â”‚
   â”œâ”€ "REGISTER ankara ankara.zenpacs.com.tr SECRET123" â”€â”€â”€>â”‚
   â”‚                                    â”‚
   â”‚                                    â”‚ 7. Relay Validates
   â”‚                                    â”‚    âœ“ Parse fields
   â”‚                                    â”‚    âœ“ Check rate limit
   â”‚                                    â”‚    âœ“ Validate subdomain
   â”‚                                    â”‚    âœ“ Check token
   â”‚                                    â”‚
   â”‚                                    â”‚ 8. Token Match?
   â”‚                                    â”‚    Config: "SECRET123"
   â”‚                                    â”‚    Received: "SECRET123"
   â”‚                                    â”‚    âœ… Match!
   â”‚                                    â”‚
   â”‚                                    â”‚ 9. Register Agent
   â”‚                                    â”‚    agents["ankara"] = {
   â”‚                                    â”‚      Connection: conn,
   â”‚                                    â”‚      Subdomain: "ankara.zenpacs.com.tr",
   â”‚                                    â”‚      LastSeen: now()
   â”‚                                    â”‚    }
   â”‚                                    â”‚
   â”‚ 10. Receive Success                â”‚
   â”‚<â”€â”€â”€â”€ "OK Registered\n" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                    â”‚
   â”‚ 11. Log Success                    â”‚
   â”‚     "âœ“ Tunnel agent started"       â”‚
   â”‚                                    â”‚
   â”‚ 12. Start Heartbeat Loop           â”‚
   â”‚     Every 30 seconds:              â”‚
   â”œâ”€â”€â”€â”€â”€ "HEARTBEAT\n" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                    â”‚â”€â”€â”€> Update LastSeen
   â”‚                                    â”‚
   â”‚ 13. Listen for Requests            â”‚
   â”‚     WebSocket messages (non-block) â”‚
   â”‚     Waiting for HTTP requests...   â”‚
   â”‚                                    â”‚
   â”‚                    [TUNNEL ACTIVE] â”‚
   â”‚                                    â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  At this point, the hospital is registered and ready to serve files  â”‚
â”‚  Users can now access: https://ankara.zenpacs.com.tr/...             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3. HTTP Request Flow (User Accessing DICOM File)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     HTTP REQUEST FLOW                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Browser              Relay Server           Hospital (Ankara)
    â”‚                          â”‚                        â”‚
    â”‚ 1. User clicks link      â”‚                        â”‚
    â”‚    https://ankara.zenpacs.com.tr                 â”‚
    â”‚         /api/instances/123/download               â”‚
    â”‚                          â”‚                        â”‚
    â”‚ 2. DNS Lookup            â”‚                        â”‚
    â”‚    ankara.zenpacs.com.tr â”‚                        â”‚
    â”‚    â†’ 45.123.45.67       â”‚                        â”‚
    â”‚                          â”‚                        â”‚
    â”‚ 3. HTTPS Connection      â”‚
    â”œâ”€â”€â”€â”€ Dial 45.123.45.67:443 â”€â”€>â”‚                   â”‚
    â”‚    TLS Handshake         â”‚                        â”‚
    â”‚<â”€â”€â”€â”€ Certificate â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚
    â”‚    (*.zenpacs.com.tr)    â”‚                        â”‚
    â”‚                          â”‚                        â”‚
    â”‚ 4. Send HTTP Request     â”‚                        â”‚
    â”œâ”€ "GET /api/instances/123/download HTTP/1.1\n"â”€â”€â”€>â”‚
    â”œâ”€ "Host: ankara.zenpacs.com.tr\n"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”œâ”€ "User-Agent: Mozilla/5.0\n"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”œâ”€ "\n" (end headers)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                          â”‚                        â”‚
    â”‚                          â”‚ 5. Protocol Detection  â”‚
    â”‚                          â”‚    Read first line:    â”‚
    â”‚                          â”‚    "GET /api/..."      â”‚
    â”‚                          â”‚    â†’ It's HTTP request â”‚
    â”‚                          â”‚                        â”‚
    â”‚                          â”‚ 6. Extract Hospital    â”‚
    â”‚                          â”‚    Host: ankara.zenpacs.com.tr
    â”‚                          â”‚    Extract: "ankara"   â”‚
    â”‚                          â”‚                        â”‚
    â”‚                          â”‚ 7. Find Tunnel         â”‚
    â”‚                          â”‚    agents["ankara"]    â”‚
    â”‚                          â”‚    â†’ Found! âœ“          â”‚
    â”‚                          â”‚                        â”‚
    â”‚                          â”‚ 8. Forward via WebSocket â”‚
    â”‚                          â”œâ”€â”€ Send over WSS â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                          â”‚    (on existing tunnel) â”‚
    â”‚                          â”‚                        â”‚
    â”‚                          â”‚ 9. Forward Request     â”‚
    â”‚                          â”œâ”€ "GET /api/instances/123/download HTTP/1.1" â”€>â”‚
    â”‚                          â”œâ”€ "Host: ankara.zenpacs.com.tr" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                          â”œâ”€ ... (all headers) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                          â”‚                        â”‚
    â”‚                          â”‚                        â”‚ 10. Process Request
    â”‚                          â”‚                        â”‚     Forward to local:
    â”‚                          â”‚                        â”‚     http://localhost:8083
    â”‚                          â”‚                        â”‚         /api/instances/123/download
    â”‚                          â”‚                        â”‚
    â”‚                          â”‚                        â”‚ 11. Gordionedge Server
    â”‚                          â”‚                        â”‚     â€¢ Query BadgerDB
    â”‚                          â”‚                        â”‚     â€¢ Find file in cache
    â”‚                          â”‚                        â”‚     â€¢ Read DICOM file
    â”‚                          â”‚                        â”‚
    â”‚                          â”‚                        â”‚ 12. Generate Response
    â”‚                          â”‚                        â”‚     HTTP/1.1 200 OK
    â”‚                          â”‚                        â”‚     Content-Type: application/dicom
    â”‚                          â”‚                        â”‚     Content-Length: 5242880
    â”‚                          â”‚                        â”‚
    â”‚                          â”‚ 13. Send Response      â”‚
    â”‚                          â”‚<â”€ HTTP/1.1 200 OK â”€â”€â”€â”€â”€â”¤
    â”‚                          â”‚<â”€ Headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                          â”‚<â”€ DICOM file data â”€â”€â”€â”€â”€â”¤
    â”‚                          â”‚   (streaming...)       â”‚
    â”‚                          â”‚                        â”‚
    â”‚ 14. Forward to User      â”‚                        â”‚
    â”‚<â”€ HTTP/1.1 200 OK â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚
    â”‚<â”€ Headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚
    â”‚<â”€ DICOM file data â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚
    â”‚   (streaming 5MB...)     â”‚                        â”‚
    â”‚                          â”‚                        â”‚
    â”‚ 15. Download Complete    â”‚                        â”‚
    â”‚    User views DICOM      â”‚                        â”‚
    â”‚    in browser/viewer     â”‚                        â”‚
    â”‚                          â”‚                        â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Total time: ~500ms (depends on file size and network)              â”‚
â”‚  File served from hospital without any inbound firewall rules       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 4. Authentication & Security Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AUTHENTICATION & RATE LIMITING FLOW                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Hospital Attempt              Relay Server              Security State
     â”‚                             â”‚                          â”‚
     â”‚ Attempt 1 (Wrong Token)     â”‚                          â”‚
     â”œâ”€ REGISTER ankara ankara.zenpacs.com.tr WRONG_TOKEN â”€â”€>â”‚
     â”‚                             â”‚                          â”‚
     â”‚                             â”‚ Validate Token          â”‚
     â”‚                             â”‚ Config: "SECRET123"     â”‚
     â”‚                             â”‚ Got: "WRONG_TOKEN"      â”‚
     â”‚                             â”‚ âŒ Mismatch             â”‚
     â”‚                             â”‚                          â”‚
     â”‚                             â”‚ Record Failed Attempt    â”‚
     â”‚                             â”‚ failedAttempts[10.1.1.50] = {
     â”‚                             â”‚   Count: 1,              â”‚
     â”‚                             â”‚   LastAttempt: now()     â”‚
     â”‚                             â”‚ }                        â”‚
     â”‚                             â”‚                          â”‚
     â”‚<â”€â”€â”€ "ERROR Invalid token\n" â”¤                          â”‚
     â”‚                             â”‚                          â”‚
     â”‚ Attempt 2-4 (Wrong Token)   â”‚                          â”‚
     â”œâ”€ REGISTER ... WRONG_TOKEN â”€>â”‚                          â”‚
     â”‚<â”€â”€â”€ "ERROR Invalid token\n" â”¤â”€â”€â”€> Count: 2, 3, 4      â”‚
     â”‚                             â”‚                          â”‚
     â”‚ Attempt 5 (Wrong Token)     â”‚                          â”‚
     â”œâ”€ REGISTER ... WRONG_TOKEN â”€>â”‚                          â”‚
     â”‚                             â”‚                          â”‚
     â”‚                             â”‚ Record Failed Attempt    â”‚
     â”‚                             â”‚ Count: 5 >= Max (5)     â”‚
     â”‚                             â”‚ ğŸš¨ RATE LIMIT TRIGGERED â”‚
     â”‚                             â”‚ BlockedUntil: now()+15minâ”‚
     â”‚                             â”‚                          â”‚
     â”‚<â”€â”€â”€ "ERROR Invalid token\n" â”¤                          â”‚
     â”‚                             â”‚                          â”‚
     â”‚ Attempt 6 (Correct Token!)  â”‚                          â”‚
     â”œâ”€ REGISTER ... SECRET123 â”€â”€â”€>â”‚                          â”‚
     â”‚                             â”‚                          â”‚
     â”‚                             â”‚ Check Rate Limit        â”‚
     â”‚                             â”‚ isRateLimited(10.1.1.50)â”‚
     â”‚                             â”‚ now() < BlockedUntil    â”‚
     â”‚                             â”‚ âœ‹ BLOCKED              â”‚
     â”‚                             â”‚                          â”‚
     â”‚<â”€ "ERROR Too many failed attempts, try again later" â”€â”€â”¤
     â”‚                             â”‚                          â”‚
     â”‚ ... Wait 15 minutes ...     â”‚                          â”‚
     â”‚                             â”‚                          â”‚
     â”‚ Attempt 7 (After cooldown)  â”‚                          â”‚
     â”œâ”€ REGISTER ... SECRET123 â”€â”€â”€>â”‚                          â”‚
     â”‚                             â”‚                          â”‚
     â”‚                             â”‚ Check Rate Limit        â”‚
     â”‚                             â”‚ now() > BlockedUntil    â”‚
     â”‚                             â”‚ âœ… Not blocked          â”‚
     â”‚                             â”‚                          â”‚
     â”‚                             â”‚ Validate Token          â”‚
     â”‚                             â”‚ "SECRET123" == "SECRET123"
     â”‚                             â”‚ âœ… Match!               â”‚
     â”‚                             â”‚                          â”‚
     â”‚                             â”‚ Clear Failed Attempts    â”‚
     â”‚                             â”‚ delete(failedAttempts[10.1.1.50])
     â”‚                             â”‚                          â”‚
     â”‚<â”€â”€â”€ "OK Registered\n" â”€â”€â”€â”€â”€â”€â”¤                          â”‚
     â”‚                             â”‚                          â”‚
     â”‚ âœ… Connected Successfully   â”‚                          â”‚
     â”‚                             â”‚                          â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Security Features:                                                  â”‚
â”‚  â€¢ Max 5 failed attempts before blocking                            â”‚
â”‚  â€¢ 15 minute block duration                                         â”‚
â”‚  â€¢ Automatic cleanup after 24 hours                                 â”‚
â”‚  â€¢ Per-IP tracking (not per-hospital)                               â”‚
â”‚  â€¢ Detailed security logging                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5. Network & Firewall Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NETWORK TOPOLOGY                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                        Internet
                           â”‚
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚               â”‚               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ User 1     â”‚  â”‚ User 2     â”‚  â”‚ User 3     â”‚
    â”‚ Laptop     â”‚  â”‚ Tablet     â”‚  â”‚ Phone      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚               â”‚               â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    DNS Resolution
                *.zenpacs.com.tr â†’ 45.123.45.67
                           â”‚
                           â–¼
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘    RELAY SERVER (Public VPS)         â•‘
        â•‘    IP: 45.123.45.67                  â•‘
        â•‘                                      â•‘
        â•‘    Ports:                            â•‘
        â•‘    â€¢ 80/TCP  - HTTP Redirect         â•‘
        â•‘    â€¢ 443/UDP - QUIC (Main)           â•‘
        â•‘    â€¢ 8080/TCP - Metrics              â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                           â”‚
                           â”‚ Internet
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚               â”‚               â”‚
           â–¼               â–¼               â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HOSPITAL ANKARA   â”‚ â”‚ HOSPITAL ISTANBUL  â”‚ â”‚  HOSPITAL SAMSUN   â”‚
â”‚  Public IP:        â”‚ â”‚  Public IP:        â”‚ â”‚  Public IP:        â”‚
â”‚  203.0.113.45      â”‚ â”‚  198.51.100.23     â”‚ â”‚  192.0.2.87        â”‚
â”‚  (NAT)             â”‚ â”‚  (NAT)             â”‚ â”‚  (NAT)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ğŸ”¥ FIREWALL         â”‚ â”‚ ğŸ”¥ FIREWALL        â”‚ â”‚ ğŸ”¥ FIREWALL     â”‚
    â”‚                     â”‚ â”‚                    â”‚ â”‚                  â”‚
    â”‚ INBOUND:            â”‚ â”‚ INBOUND:           â”‚ â”‚ INBOUND:         â”‚
    â”‚ âŒ Port 443: DENY   â”‚ â”‚ âŒ Port 443: DENY  â”‚ â”‚ âŒ Port 443: DENYâ”‚
    â”‚ âŒ Port 8083: DENY  â”‚ â”‚ âŒ Port 8083: DENY â”‚ â”‚ âŒ Port 8083: DENY
    â”‚ âŒ Port 11113: DENY â”‚ â”‚ âŒ Port 11113: DENYâ”‚ â”‚ âŒ Port 11113: DENY
    â”‚                     â”‚ â”‚                    â”‚ â”‚                  â”‚
    â”‚ OUTBOUND:           â”‚ â”‚ OUTBOUND:          â”‚ â”‚ OUTBOUND:        â”‚
    â”‚ âœ… Port 443: ALLOW  â”‚ â”‚ âœ… Port 443: ALLOW â”‚ â”‚ âœ… Port 443: ALLOW
    â”‚ âœ… HTTPS: ALLOW     â”‚ â”‚ âœ… HTTPS: ALLOW    â”‚ â”‚ âœ… HTTPS: ALLOW  â”‚
    â”‚                     â”‚ â”‚                    â”‚ â”‚                  â”‚
    â”‚ ESTABLISHED:        â”‚ â”‚ ESTABLISHED:       â”‚ â”‚ ESTABLISHED:     â”‚
    â”‚ âœ… Return traffic   â”‚ â”‚ âœ… Return traffic  â”‚ â”‚ âœ… Return trafficâ”‚
    â”‚    on established   â”‚ â”‚    on established  â”‚ â”‚    on establishedâ”‚
    â”‚    connections      â”‚ â”‚    connections     â”‚ â”‚    connections   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                       â”‚                       â”‚
              â”‚ Private Network       â”‚ Private Network       â”‚ Private Network
              â”‚ 10.1.1.0/24          â”‚ 10.2.1.0/24          â”‚ 10.3.1.0/24
              â”‚                       â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ GORDIONEDGE        â”‚ â”‚ GORDIONEDGE       â”‚ â”‚ GORDIONEDGE      â”‚
    â”‚ 10.1.1.50          â”‚ â”‚ 10.2.1.50         â”‚ â”‚ 10.3.1.50        â”‚
    â”‚                    â”‚ â”‚                   â”‚ â”‚                  â”‚
    â”‚ â€¢ DICOM: 11113     â”‚ â”‚ â€¢ DICOM: 11113    â”‚ â”‚ â€¢ DICOM: 11113   â”‚
    â”‚ â€¢ HTTP: 8083       â”‚ â”‚ â€¢ HTTP: 8083      â”‚ â”‚ â€¢ HTTP: 8083     â”‚
    â”‚ â€¢ Tunnel: Active   â”‚ â”‚ â€¢ Tunnel: Active  â”‚ â”‚ â€¢ Tunnel: Active â”‚
    â”‚                    â”‚ â”‚                   â”‚ â”‚                  â”‚
    â”‚ Outbound to:       â”‚ â”‚ Outbound to:      â”‚ â”‚ Outbound to:     â”‚
    â”‚ relay:443 âœ…       â”‚ â”‚ relay:443 âœ…      â”‚ â”‚ relay:443 âœ…     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KEY INSIGHT:                                                        â”‚
â”‚  â€¢ Hospitals initiate OUTBOUND connections (firewall allows)        â”‚
â”‚  â€¢ Return traffic on established connections is allowed             â”‚
â”‚  â€¢ NO inbound ports need to be opened                               â”‚
â”‚  â€¢ Relay server uses existing connection to send requests           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 6. Data Flow - DICOM File Upload & Download

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              COMPLETE DATA FLOW (CT Scan to Doctor)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

HOSPITAL                    GORDIONEDGE                RELAY         DOCTOR
(CT Scanner)                (10.1.1.50)              (Cloud)       (Browser)

    â”‚                            â”‚                        â”‚              â”‚
    â”‚ 1. CT Scan Complete        â”‚                        â”‚              â”‚
    â”‚    Patient: John Doe       â”‚                        â”‚              â”‚
    â”‚    Study: CT Brain         â”‚                        â”‚              â”‚
    â”‚    Images: 120 slices      â”‚                        â”‚              â”‚
    â”‚                            â”‚                        â”‚              â”‚
    â”‚ 2. DICOM C-STORE           â”‚                        â”‚              â”‚
    â”œâ”€ Send 120 DICOM files â”€â”€â”€â”€>â”‚                        â”‚              â”‚
    â”‚    (port 11113)            â”‚                        â”‚              â”‚
    â”‚                            â”‚ 3. Process Images      â”‚              â”‚
    â”‚                            â”‚    â€¢ Save to BadgerDB  â”‚              â”‚
    â”‚                            â”‚    â€¢ Store in cache    â”‚              â”‚
    â”‚                            â”‚    â€¢ Compress (GDCM)   â”‚              â”‚
    â”‚                            â”‚    â€¢ Generate metadata â”‚              â”‚
    â”‚                            â”‚                        â”‚              â”‚
    â”‚                            â”‚ 4. Upload to MinIO     â”‚              â”‚
    â”‚                            â”œâ”€ Upload compressed â”€â”€>MinIO           â”‚
    â”‚                            â”‚   (s3.zenpacs.com.tr) â”‚              â”‚
    â”‚                            â”‚                        â”‚              â”‚
    â”‚                            â”‚ 5. Generate Weasis XML â”‚              â”‚
    â”‚                            â”‚    Study metadata      â”‚              â”‚
    â”‚                            â”‚    Instance URLs       â”‚              â”‚
    â”‚                            â”‚                        â”‚              â”‚
    â”‚                            â”‚ 6. Publish to NATS     â”‚              â”‚
    â”‚                            â”œâ”€ Study Completed â”€â”€â”€â”€>NATS            â”‚
    â”‚                            â”‚   Topic: dicom.study   â”‚              â”‚
    â”‚                            â”‚                        â”‚              â”‚
    â”‚                            â”‚ 7. Ready to Serve      â”‚              â”‚
    â”‚                            â”‚    Tunnel: Active âœ…   â”‚              â”‚
    â”‚                            â”‚<â”€â”€â”€â”€â”€â”€ Connected â”€â”€â”€â”€â”€â”€â”¤              â”‚
    â”‚                            â”‚                        â”‚              â”‚
    â”‚                            â”‚                        â”‚              â”‚
    â”‚                            â”‚                        â”‚ 8. Doctor     â”‚
    â”‚                            â”‚                        â”‚    Receives   â”‚
    â”‚                            â”‚                        â”‚    Notification
    â”‚                            â”‚                        â”‚              â”‚
    â”‚                            â”‚                        â”‚ 9. Click Link â”‚
    â”‚                            â”‚                        â”‚    ankara.zenpacs.com.tr
    â”‚                            â”‚                        â”‚    /weasis.xmlâ”‚
    â”‚                            â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                            â”‚                        â”‚              â”‚
    â”‚                            â”‚                        â”‚ 10. Route to  â”‚
    â”‚                            â”‚                        â”‚     Hospital  â”‚
    â”‚                            â”‚ 11. Request Weasis XML â”‚              â”‚
    â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
    â”‚                            â”‚    (via tunnel)        â”‚              â”‚
    â”‚                            â”‚                        â”‚              â”‚
    â”‚                            â”‚ 12. Serve Weasis XML   â”‚              â”‚
    â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
    â”‚                            â”‚    (contains URLs)     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                            â”‚                        â”‚              â”‚
    â”‚                            â”‚                        â”‚ 13. Parse XML â”‚
    â”‚                            â”‚                        â”‚     Get image â”‚
    â”‚                            â”‚                        â”‚     URLs      â”‚
    â”‚                            â”‚                        â”‚              â”‚
    â”‚                            â”‚                        â”‚ 14. Request   â”‚
    â”‚                            â”‚                        â”‚     Images    â”‚
    â”‚                            â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                            â”‚                        â”‚   GET /api/   â”‚
    â”‚                            â”‚                        â”‚   instances/  â”‚
    â”‚                            â”‚                        â”‚   001/downloadâ”‚
    â”‚                            â”‚                        â”‚              â”‚
    â”‚                            â”‚ 15. Serve Images       â”‚              â”‚
    â”‚                            â”‚    (120 requests)      â”‚              â”‚
    â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
    â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
    â”‚                            â”‚    DICOM files         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                            â”‚    (from cache or MinIO)              â”‚
    â”‚                            â”‚                        â”‚              â”‚
    â”‚                            â”‚                        â”‚ 16. View      â”‚
    â”‚                            â”‚                        â”‚     Study in  â”‚
    â”‚                            â”‚                        â”‚     Browser   â”‚
    â”‚                            â”‚                        â”‚              â”‚
    â”‚                            â”‚                        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”‚
    â”‚                            â”‚                        â”‚     â”‚ CT    â”‚â”‚
    â”‚                            â”‚                        â”‚     â”‚ Brain â”‚â”‚
    â”‚                            â”‚                        â”‚     â”‚ 120   â”‚â”‚
    â”‚                            â”‚                        â”‚     â”‚ imagesâ”‚â”‚
    â”‚                            â”‚                        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”˜â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Total time from scan to view: 2-5 minutes                          â”‚
â”‚  â€¢ C-STORE: 1-2 min (depends on image count)                        â”‚
â”‚  â€¢ Processing: 30-60 sec (compression, metadata)                    â”‚
â”‚  â€¢ Upload: 30-60 sec (to MinIO, if configured)                      â”‚
â”‚  â€¢ View: < 10 sec (tunnel routing)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 7. Component Interaction Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMPONENT INTERACTION                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        RELAY SERVER                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              main.go (Entry Point)                        â”‚
    â”‚  â€¢ Load configuration                                     â”‚
    â”‚  â€¢ Setup logging                                          â”‚
    â”‚  â€¢ Create Server instance                                 â”‚
    â”‚  â€¢ Start server                                           â”‚
    â”‚  â€¢ Handle signals (Ctrl+C)                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              Server (relay/server.go)                     â”‚
    â”‚                                                           â”‚
    â”‚  Components:                                              â”‚
    â”‚  â€¢ QUIC Listener (port 443/UDP)                          â”‚
    â”‚  â€¢ HTTP Redirect Server (port 80/TCP)                    â”‚
    â”‚  â€¢ Metrics Server (port 8080/TCP)                        â”‚
    â”‚  â€¢ Agent Registry (map[hospitalCode]Connection)          â”‚
    â”‚  â€¢ Rate Limiter (map[IP]FailedAttempts)                  â”‚
    â”‚  â€¢ TLS Manager (Let's Encrypt or manual)                 â”‚
    â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚               â”‚              â”‚              â”‚
      â”‚               â”‚              â”‚              â”‚
   â”Œâ”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ Accept â”‚   â”‚ HTTP     â”‚   â”‚ Metrics  â”‚   â”‚ Rate    â”‚
   â”‚ QUIC   â”‚   â”‚ Redirect â”‚   â”‚ /status  â”‚   â”‚ Limiter â”‚
   â”‚ Conn   â”‚   â”‚ Server   â”‚   â”‚ /health  â”‚   â”‚ Cleanup â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ For each connection
       â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  handleConnection()                    â”‚
   â”‚  â€¢ Accept first stream                 â”‚
   â”‚  â€¢ Read first line                     â”‚
   â”‚  â€¢ Determine protocol                  â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚
       â”‚                   â”‚
    "REGISTER ..."    "GET /api/..."
       â”‚                   â”‚
       â–¼                   â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Tunnel    â”‚    â”‚  HTTP        â”‚
   â”‚  Register  â”‚    â”‚  Request     â”‚
   â”‚            â”‚    â”‚              â”‚
   â”‚  â€¢ Parse   â”‚    â”‚  â€¢ Extract   â”‚
   â”‚  â€¢ Validateâ”‚    â”‚    subdomain â”‚
   â”‚  â€¢ Auth    â”‚    â”‚  â€¢ Find      â”‚
   â”‚  â€¢ Store   â”‚    â”‚    tunnel    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â€¢ Forward   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      GORDIONEDGE (Hospital)                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              main.go (Entry Point)                        â”‚
    â”‚  â€¢ Load configuration                                     â”‚
    â”‚  â€¢ Setup logging                                          â”‚
    â”‚  â€¢ Create EdgeService                                     â”‚
    â”‚  â€¢ Start service                                          â”‚
    â”‚  â€¢ Handle signals                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         EdgeService (service/service_impl.go)             â”‚
    â”‚                                                           â”‚
    â”‚  Components:                                              â”‚
    â”‚  â€¢ BadgerDB Pipeline                                      â”‚
    â”‚  â€¢ DICOM Server (port 11113)                             â”‚
    â”‚  â€¢ HTTP Server (port 8083)                               â”‚
    â”‚  â€¢ MinIO Client                                           â”‚
    â”‚  â€¢ NATS Publisher                                         â”‚
    â”‚  â€¢ Tunnel Agent â† NEW                                    â”‚
    â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚       â”‚        â”‚       â”‚        â”‚          â”‚
      â”‚       â”‚        â”‚       â”‚        â”‚          â”‚
   â”Œâ”€â”€â–¼â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
   â”‚DICOMâ”‚ â”‚HTTP â”‚ â”‚Minioâ”‚ â”‚NATS â”‚  â”‚Cache â”‚  â”‚ Tunnel   â”‚
   â”‚C-   â”‚ â”‚API  â”‚ â”‚Uploadâ”‚ â”‚Pub  â”‚  â”‚Mgmt  â”‚  â”‚ Agent    â”‚
   â”‚STOREâ”‚ â”‚Serveâ”‚ â”‚     â”‚ â”‚     â”‚  â”‚      â”‚  â”‚          â”‚
   â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚       â”‚                                       â”‚
      â”‚       â”‚                                       â”‚
      â”‚       â”‚ Serves files locally                  â”‚
      â”‚       â”‚ on localhost:8083                     â”‚
      â”‚       â”‚                                       â”‚
      â”‚       â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚       â”‚                          â”‚  tunnel/agent.go    â”‚
      â”‚       â”‚                          â”‚                     â”‚
      â”‚       â”‚                          â”‚  â€¢ Connect to relay â”‚
      â”‚       â”‚                          â”‚  â€¢ Register tunnel  â”‚
      â”‚       â”‚                          â”‚  â€¢ Send heartbeat   â”‚
      â”‚       â”‚                          â”‚  â€¢ Accept streams   â”‚
      â”‚       â”‚                          â”‚  â€¢ Forward requests â”‚
      â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    to localhost     â”‚
      â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ DICOM files from CT/MRI scanners
      â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  DICOM Pipeline                 â”‚
   â”‚  1. Receive Stage               â”‚
   â”‚  2. Compress Stage (optional)   â”‚
   â”‚  3. Storage Stage (cache)       â”‚
   â”‚  4. Upload Stage (MinIO)        â”‚
   â”‚  5. XML Generation Stage        â”‚
   â”‚  6. NATS Publish Stage          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

These diagrams show the complete system architecture, data flow, security mechanisms, and component interactions. The system successfully allows hospitals behind firewalls to serve DICOM files publicly without any inbound port configuration!
